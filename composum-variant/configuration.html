<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 2.0.0-M19 from src/site/markdown/composum-variant/configuration.md at $dateFormat.format( $currentDate )
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 2.0.0-M19" />
    <title>Configuration of the Composum AI within Composum Pages – Composum AI</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.8.min.js"></script>
<meta property="og:url" content="https://ai.composum.com">
            <meta property="og:type" content="website">
            <meta property="og:title" content="Composum AI – Enhancing Content Management with AI">
            <meta property="og:description" content="Artificial intelligence for the editor in Composum Pages CMS and Adobe AEM : content creation and analysis, translation, suggestions, ...">
            <meta property="og:image" content="https://ai.composum.com/image/ComposumAILogo.jpg">
            <meta name="twitter:card" content="summary_large_image">
            <meta property="twitter:domain" content="ai.composum.com">
            <meta property="twitter:url" content="https://ai.composum.com">
            <meta name="twitter:title" content="Composum AI – Enhancing Content Management with AI">
            <meta name="twitter:description" content="Artificial intelligence for the editor in Composum Pages CMS and Adobe AEM : content creation and analysis, translation, suggestions, ...">
            <meta name="twitter:image" content="https://ai.composum.com/image/ComposumAILogo.jpg">
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left">            <h1>Composum AI
</h1></div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">$i18n.getString( "site-renderer", $locale, "template.lastpublished" ): $dateValue<span class="divider">|</span>
</li>
          <li id="projectVersion">$i18n.getString( "site-renderer", $locale, "template.version" ): 2.0.1<span class="divider">|</span></li>
      <li class=""><a href="../index.html" title="Composum AI Site">Composum AI Site</a><span class="divider">/</span></li>
    <li class="active ">Configuration of the Composum AI within Composum Pages</li>
      <li class="pull-right"><span class="divider">|</span>
<a href="https://www.ist-software.com/" class="externalLink" title="IST Gmbh Dresden">IST Gmbh Dresden</a></li>
      <li class="pull-right"><a href="http://www.composum.com/" class="externalLink" title="Composum">Composum</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li><a href="../index.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../development.html" title="Development documentation"><span class="none"></span>Development documentation</a></li>
    <li><a href="../prototypes.html" title="Prototypes"><span class="none"></span>Prototypes</a></li>
    <li><a href="../aiPageTemplating.html" title="AI Page Templating"><span class="none"></span>AI Page Templating</a></li>
    <li><a href="https://www.composum.com/home/contact.html" class="externalLink" title="Contact Us"><span class="none"></span>Contact Us</a></li>
   <li class="nav-header">AEM-Variant</li>
    <li><a href="../aem-variant/index.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../aem-variant/installation.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li><a href="../aem-variant/configuration.html" title="Configuration"><span class="none"></span>Configuration</a></li>
    <li><a href="../aem-variant/usage.html" title="Usage"><span class="none"></span>Usage</a></li>
    <li><a href="../aem-variant/automaticTranslation.html" title="Automatic Translation"><span class="none"></span>Automatic Translation</a></li>
   <li class="nav-header">Composum-Variant</li>
    <li><a href="../composum-variant/index.html" title="Overview"><span class="none"></span>Overview</a></li>
    <li><a href="../composum-variant/installation.html" title="Installation"><span class="none"></span>Installation</a></li>
    <li class="active"><a href="#"><span class="none"></span>Configuration</a></li>
    <li><a href="../composum-variant/usage.html" title="Usage"><span class="none"></span>Usage</a></li>
   <li class="nav-header">References / Lists</li>
    <li><a href="../autogenerated/osgiconfigurations.html" title="OSGI Configurations"><span class="none"></span>OSGI Configurations</a></li>
    <li><a href="../autogenerated/slingcaconfigurations.html" title="Sling CA Configurations"><span class="none"></span>Sling CA Configurations</a></li>
   <li class="nav-header">Parent Project</li>
    <li><a href="../../index.html" title="Composum Platform"><span class="none"></span>Composum Platform</a></li>
   <li class="nav-header">Modules</li>
    <li><a href="../composum-ai-integration-backend/index.html" title="Composum AI::Backend"><span class="none"></span>Composum AI::Backend</a></li>
    <li><a href="../composum-ai-integration-composum/index.html" title="Composum AI::Frontend"><span class="none"></span>Composum AI::Frontend</a></li>
    <li><a href="../composum-ai/index.html" title="Composum AI::AEM"><span class="none"></span>Composum AI::AEM</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="$i18n.getString( "site-renderer", $locale, "template.builtby" ) Maven" class="poweredBy"><img class="builtBy" alt="$i18n.getString( "site-renderer", $locale, "template.builtby" ) Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<section><a id="Configuration_of_the_Composum_AI_within_Composum_Pages"></a>
<h1>Configuration of the Composum AI within Composum Pages</h1>
<p>The configuration is designed so that the Composum API is easy to try out without any configuration besides an
OpenAI API key used to access the
<a href="https://platform.openai.com/docs/guides/text-generation/chat-completions-api" class="externalLink">ChatGPT chat completions API</a>
for the whole site. This makes the AI available in all places it supports. But it is possible to restrict the usage
of the AI e.g. to page trees, certain page templates or components, as well as to certain users and groups.</p>
<p>Generally, the configuration has several levels of fallbacks. If present,
[Sling Context Aware Configuration]
(<a href="https://sling.apache.org/documentation/bundles/context-aware-configuration/context-aware-configuration.html" class="externalLink">https://sling.apache.org/documentation/bundles/context-aware-configuration/context-aware-configuration.html</a>)
overrides all other configuration methods. That falls back to an OSGI configuration, for which there are sometimes
other fallbacks.</p>
<p>See also the <a href="../autogenerated/osgiconfigurations.html">OSGI configuration reference</a> /
<a href="../autogenerated/slingcaconfigurations.html">Sling CA configuration reference</a> for the Composum AI.</p><section><a id="LLM_API_Key_and_general_configuration"></a>
<h2>LLM API Key and general configuration</h2>

<div style="float: right; margin-left: 20px;">
   <a href="../image/ai/configuration/OpenAiConfiguration.png">
    <img src="../image/ai/configuration/OpenAiConfiguration.png" alt="LLM configuration" width="400" />
  </a>
</div>

<p>The Composum AI can be configured to use OpenAI services or other LLM that have a compatible interface, like local LLM.</p><section><a id="Configuration_to_use_OpenAI_services"></a>
<h3>Configuration to use OpenAI services</h3>
<p>Using the Composum AI needs an <a href="https://platform.openai.com/api-keys" class="externalLink">OpenAI API key</a> that can either be configured for
the whole server in the OSGI configuration &#x201c;Composum AI OpenAI Configuration&#x201d; or flexibly per site or
content-tree with Sling Context Aware Configuration in the &#x201c;Composum AI OpenAI Configuration&#x201d;.</p>
<p>For the OpenAI key there is a fallback hierarchy:</p>
<ul>

<li>Sling Context Aware Configuration with the configuration class
<code>com.composum.ai.backend.slingbase.model.OpenAIConfig</code></li>
<li>OSGI configuration at &#x201c;Composum AI OpenAI Configuration&#x201d;</li>
<li>Environment variable OPENAI_API_KEY</li>
<li>System property openai.api.key</li>
</ul>
<p>For the OSGI configuration there are the following configurations:</p>
<table class="table table-striped">
<thead>
<tr class="a">
<th>id</th>
<th>name</th>
<th>type</th>
<th>default value</th>
<th>description</th></tr></thead><tbody>
<tr class="b">
<td>disabled</td>
<td>Disable</td>
<td>Boolean</td>
<td>false</td>
<td>Disable the GPT Chat Completion Service</td></tr>
<tr class="a">
<td>chatCompletionUrl</td>
<td>URL of the chat completion service</td>
<td>String</td>
<td> </td>
<td>Optional, if not OpenAI's default <a href="https://api.openai.com/v1/chat/completions" class="externalLink">https://api.openai.com/v1/chat/completions</a></td></tr>
<tr class="b">
<td>openAiApiKey</td>
<td>OpenAI API key</td>
<td>String</td>
<td> </td>
<td>OpenAI API key from <a href="https://platform.openai.com/" class="externalLink">https://platform.openai.com/</a>. If not given, we check the key file, the environment Variable OPENAI_API_KEY, and the system property openai.api.key .</td></tr>
<tr class="a">
<td>openAiOrganizationId</td>
<td>OpenAI Organization ID</td>
<td>String</td>
<td> </td>
<td>Optionally, OpenAI Organization ID from <a href="https://platform.openai.com/account/organization" class="externalLink">https://platform.openai.com/account/organization</a> .</td></tr>
<tr class="b">
<td>openAiApiKeyFile</td>
<td>OpenAI API key file</td>
<td>String</td>
<td> </td>
<td>Key File containing the API key, as an alternative to Open AKI Key configuration and the variants described there.</td></tr>
<tr class="a">
<td>defaultModel</td>
<td>Default model</td>
<td>String</td>
<td>gpt-4o-mini</td>
<td>Default model to use for the chat completion. The default if not set is gpt-4o-mini. Please consider the varying prices <a href="https://openai.com/pricing" class="externalLink">https://openai.com/pricing</a> .</td></tr>
<tr class="b">
<td>highIntelligenceModel</td>
<td>High intelligence model</td>
<td>String</td>
<td>gpt-4o</td>
<td>The model that is used for requests that need more reasoning performance. The default if not set is gpt-4o. Please consider the varying prices <a href="https://openai.com/pricing" class="externalLink">https://openai.com/pricing</a> .</td></tr>
<tr class="a">
<td>imageModel</td>
<td>Vision model</td>
<td>String</td>
<td>gpt-4o</td>
<td>Optional, a model that is used if an image is given as input, e.g. gpt-4o. If not given, image recognition is rejected.</td></tr>
<tr class="b">
<td>temperature</td>
<td>Temperature</td>
<td>String</td>
<td> </td>
<td>Optional temperature setting that determines variability and creativity as a floating point between 0.0 and 1.0</td></tr>
<tr class="a">
<td>maximumTokensPerRequest</td>
<td>Maximum Tokens per Request</td>
<td>Integer</td>
<td>50000</td>
<td>If &gt; 0 limit to the maximum number of tokens per request. That's about a twice the word count. Caution: Compare with the pricing - on GPT-4 models a thousand tokens might cost $0.01 or more.</td></tr>
<tr class="b">
<td>maximumTokensPerResponse</td>
<td>Maximum output tokens per request</td>
<td>Integer</td>
<td>4096</td>
<td>Maximum number of tokens to return in the response. Must not exceed the capabilities of the model - as of 10/03/24 this is 4096 for most OpenAI models - which is the default, so no need to set that.</td></tr>
<tr class="a">
<td>connectionTimeout</td>
<td>Connection timeout in seconds</td>
<td>Integer</td>
<td>20</td>
<td>Default 20</td></tr>
<tr class="b">
<td>requestTimeout</td>
<td>Request timeout in seconds</td>
<td>Integer</td>
<td>120</td>
<td>Default 120</td></tr>
<tr class="a">
<td>requestsPerMinute</td>
<td>Maximum requests per minute</td>
<td>Integer</td>
<td>100</td>
<td>Maximum count of requests to ChatGPT per minute - from the second half there will be a slowdown to avoid hitting the limit. Default 100</td></tr>
<tr class="b">
<td>requestsPerHour</td>
<td>Maximum requests per hour</td>
<td>Integer</td>
<td>1000</td>
<td>Maximum count of requests to ChatGPT per hour - from the second half there will be a slowdown to avoid hitting the limit. Default 1000</td></tr>
<tr class="a">
<td>requestsPerDay</td>
<td>Maximum requests per day</td>
<td>Integer</td>
<td>3000</td>
<td>Maximum count of requests to ChatGPT per day - from the second half there will be a slowdown to avoid hitting the limit. Default 3000</td></tr>
<tr class="b">
<td>embeddingsUrl</td>
<td>URL of the embeddings service</td>
<td>String</td>
<td> </td>
<td>Optional, if not OpenAI's default <a href="https://api.openai.com/v1/embeddings" class="externalLink">https://api.openai.com/v1/embeddings</a></td></tr>
<tr class="a">
<td>embeddingsModel</td>
<td>Embeddings model</td>
<td>String</td>
<td>text-embedding-3-small</td>
<td>Optional model to use for the embeddings. The default is text-embedding-3-small.</td></tr></tbody>
</table>

<p>If Sling Context Aware Configuration contains an entry for <code>com.composum.ai.backend.slingbase.model.OpenAIConfig</code>,
then the OpenAI API Key is taken from the configuration <code>openAiApiKey</code> of that <code>Composum AI OpenAI Configuration</code> of
the edited page or experience fragment. If that is not present, the fallback hierarchy is used. The context aware
configuration permits using different OpenAI API keys for different parts of the site. If only a single key is
desired, a global default can be set at e.g.
/conf/global/sling:configs/com.composum.ai.backend.slingbase.model.OpenAIConfig</p>

<pre><code class="language-json">{
  &quot;jcr:primaryType&quot;: &quot;nt:unstructured&quot;,
  &quot;openAiApiKey&quot;: &quot;sk-******&quot;
}
</code></pre>
<p>where sk-****** should be replaced by the actual OpenAI API key.</p>

<div style="clear: both;"></div>

<p></p></section><section><a id="Using_local_LLM"></a>
<h3>Using local LLM</h3>
<p>There are
<a href="https://medium.com/thedeephub/50-open-source-options-for-running-llms-locally-db1ec6f5a54f" class="externalLink">many ways to run open source LLM locally</a>
, e.g. <a href="https://lmstudio.ai/" class="externalLink">LM Studio</a>. Often these offer interfaces like the OpenAI chat completion service, and
do not need any API key. In that case you'll just need to configure the chatCompletionUrl to the appropriate value
of the server.</p></section><section><a id="Using_other_LLM"></a>
<h3>Using other LLM</h3>
<p>Using other LLM might need some small modifications for authorization headers and possibly a different interface - if
you need that please <a href="https://www.composum.com/home/contact.html" class="externalLink">contact us</a>.</p></section></section><section><a id="Composum_AI_Prompt_Library_Configuration"></a>
<h2>Composum AI Prompt Library Configuration</h2>
<p>Composum AI provides a default prompt library for the Content Creation Assistant and the Side Panel Assistant. It is
quite likely that you will want to customize the prompts or add new prompts for your specific use case, or use prompts
in a different language than english. This can be
done with the &#x201c;Composum AI Prompt Library Configuration&#x201d;. There is an OSGI configuration that can set system-wide
default paths, and a Sling Context Aware Configuration that can override these defaults for specific parts of the site.</p>
<table class="table table-striped">
<thead>
<tr class="a">
<th>id</th>
<th>label</th>
<th>type</th>
<th>default value</th>
<th>description</th></tr></thead><tbody>
<tr class="b">
<td>contentCreationPromptsPath</td>
<td>Content Creation Prompts Path</td>
<td>String</td>
<td> </td>
<td>Path to the content creation prompts.</td></tr>
<tr class="a">
<td>sidePanelPromptsPath</td>
<td>Side Panel Prompts Path</td>
<td>String</td>
<td> </td>
<td>Path to the side panel prompts.</td></tr></tbody>
</table>

<p>These paths can be paths to a JSON file like
<a href="https://github.com/ist-dresden/composum-AI/blob/develop/composum/bundle/src/main/resources/create/predefinedprompts.json" class="externalLink">predefinedprompts.json</a>
. To make it easy to maintain a prompt library, it is also possible to use content pages as prompt library. The
content page should have a simple structure and the prompts should be as components in exactly one paragraph system
containing text components with the prompts. The subtitle in the text component is taken as the title of the prompt, and
the text is taken as the text of the prompt.</p>
<dl>

<dt>If you want to adapt the default prompt libraries</dt>
<dt><code>/libs/composum/pages/options/ai/dialogs/create/defaultprompts</code></dt>
<dt><code>/libs/composum/pages/options/ai/tools/sidebar/defaultprompts</code></dt>
<dd>these can be copied into the site or some other place and edited there.</dd>
</dl>

<div style="clear: both;"></div>
</section><section><a id="AI_Permission_Configuration"></a>
<h2>AI Permission Configuration</h2>

<div style="float: right; margin-left: 20px;">
   <a href="../image/ai/configuration/AIPermissionConfiguration.png">
    <img src="../image/ai/configuration/AIPermissionConfiguration.png" alt="Sidebar AI" width="400" />
  </a>
</div>

<p>We also use a fallback hierarchy for the permission configuration:</p>
<ul>

<li>Sling Context Aware Configuration</li>
<li>an OSGI configuration factory at &#x201c;Composum AI Permission Configuration&#x201d;</li>
<li>a single OSGI configuration at &#x201c;Composum AI Permission Configuration&#x201d; that is the default configuration when
nothing else is found, and normally allows all services for all users etc. if not changed.</li>
</ul>
<p>The context aware configuration and the OSGI configuration factory both allow configuring lists of configurations to
allow configuring different permissions for different parts of the site. Permissions are thus additive. If any of the
fallback levels has an entry, the lower fallback levels are not considered at all. Thus, if the context aware
configuration is not used and the factory is not used either, then the default &#x201c;all allowing&#x201d; configuration is used,
which it is ignored otherwise. If using context aware configuration it's sensible to provide a default
configuration at e.g.
/conf/global/sling:configs/com.composum.ai.backend.slingbase.model.GPTPermissionConfiguration/entry1
that forbids everything for sites where sling context aware configuration is not configured as a default, and then
add configurations for the parts where it is allowed.</p>
<p>For the sling context aware configuration, we have a configuration list at
<code>com.composum.ai.backend.slingbase.model.GPTPermissionConfiguration</code> , which is also used in the OSGI configuration.
It has the following properties:</p>
<table class="table table-striped">
<thead>
<tr class="a">
<th>Configuration Key</th>
<th>Description</th>
<th>Default Value</th></tr></thead><tbody>
<tr class="b">
<td>services</td>
<td>List of services to which this configuration applies. Possible values are: &#x201c;categorize&#x201d;, &#x201c;create&#x201d;, &#x201c;sidepanel&#x201d;, &#x201c;translate&#x201d; . For AEM only create and sidepanel are supported.</td>
<td>categorize, create, sidepanel, translate</td></tr>
<tr class="a">
<td>allowedUsers</td>
<td>Regular expressions for allowed users or user groups. If not present, no user is allowed from this configuration.</td>
<td>.*</td></tr>
<tr class="b">
<td>deniedUsers</td>
<td>Regular expressions for denied users or user groups. Takes precedence over allowed users.</td>
<td> </td></tr>
<tr class="a">
<td>allowedPaths</td>
<td>Regular expressions for allowed content paths. If not present, no paths are allowed.</td>
<td>/content/.*</td></tr>
<tr class="b">
<td>deniedPaths</td>
<td>Regular expressions for denied content paths. Takes precedence over allowed paths.</td>
<td>/content/dam/.*</td></tr>
<tr class="a">
<td>allowedViews</td>
<td>Regular expressions for allowed views - that is, for URLs like /editor.html/.* . If not present, no views are allowed. Use .* to allow all views.</td>
<td>.*</td></tr>
<tr class="b">
<td>deniedViews</td>
<td>Regular expressions for denied views. Takes precedence over allowed views.</td>
<td> </td></tr>
<tr class="a">
<td>allowedComponents</td>
<td>Regular expressions for allowed resource types of components. If not present, no components are allowed.</td>
<td>.*</td></tr>
<tr class="b">
<td>deniedComponents</td>
<td>Regular expressions for denied resource types of components. Takes precedence over allowed components.</td>
<td> </td></tr>
<tr class="a">
<td>allowedPageTemplates</td>
<td>Regular expressions for allowed page templates. If not present, all page templates are allowed.</td>
<td>.*</td></tr>
<tr class="b">
<td>deniedPageTemplates</td>
<td>Regular expressions for denied page templates. Takes precedence over allowed page templates.</td>
<td> </td></tr></tbody>
</table>

<p>The general principle is that a configuration allows using one or more services (that is, assistant dialogs) for
everything that matches the allows* properties and does not match the denied* properties - thus the denied takes
precedence.</p>
<p>It is possible to create several list entries allowing a subset of the services (dialogs) for a subset of users,
sites, components and so forth. Permissions are additive.</p>
<p>Example: for allowing all services for all users etc. on the subtree /content/wknd you could have the following entry at
<code>/conf/wknd/sling:configs/com.composum.ai.backend.slingbase.model.GPTPermissionConfiguration/entry1</code>
if <code>/content/wknd/jcr:content</code> has a <code>sling:configRef</code> pointing to <code>/conf/wknd</code>.</p>

<pre><code class="language-json">{
  &quot;jcr:primaryType&quot;: &quot;nt:unstructured&quot;,
  &quot;services&quot;: [
    &quot;categorize&quot;,
    &quot;create&quot;,
    &quot;sidepanel&quot;,
    &quot;translate&quot;
  ],
  &quot;allowedUsers&quot;: [
    &quot;.*&quot;
  ],
  &quot;deniedUsers&quot;: [
    &quot;.*&quot;
  ],
  &quot;allowedPaths&quot;: [
    &quot;/content/.*&quot;
  ],
  &quot;deniedPaths&quot;: [
    &quot;/content/dam/.*&quot;
  ],
  &quot;allowedViews&quot;: [
    &quot;.*&quot;
  ],
  &quot;deniedViews&quot;: [
    &quot;&quot;
  ],
  &quot;allowedComponents&quot;: [
    &quot;.*&quot;
  ],
  &quot;deniedComponents&quot;: [
    &quot;&quot;
  ],
  &quot;allowedPageTemplates&quot;: [
    &quot;.*&quot;
  ],
  &quot;deniedPageTemplates&quot;: [
    &quot;&quot;
  ]
}
</code></pre></section><section><a id="Specification"></a>
<h2>Specification</h2>
<p>For even more details see the
<a href="https://github.com/ist-dresden/composum-AI/blob/develop/featurespecs/6Configuration.md" class="externalLink">specification</a></p></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      ${currentYear}..</p>
        </div>
      </div>
    </footer>
  </body>
</html>
